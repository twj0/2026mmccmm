# Q1：反推粉丝投票（Fan Vote Estimation）

## 0. 我对题目的理解（聚焦 Q1）

- 已知：每季每位选手每周评委打分（1–10，可能含小数；淘汰后周分记为 0；不存在的周为 N/A）、赛季最终名次/结果文本。
- 未知：每周粉丝投票（绝对票数未知且不可得）。
- 目标：为每个 `season-week-celebrity` 估计**相对粉丝投票强度**（fan vote share / fan vote index），并给出不确定性；要求与真实淘汰结果一致（或概率上高度一致）。

关键点：这是一个 **identifiability 受限**的问题。合理产出是“份额/指数 + 区间”，而不是“百万票”。

## 1. 数据检查（可用性与可信度）

### 1.1 官方数据（2026_MCM_Problem_C_Data.csv）

- **结构**：wide 表（`weekX_judgeY_score`），并附带选手静态信息（年龄、行业、舞伴等）+ `results/placement`。
- **缺失机制**：
  - `N/A`：该季不存在的周 / 当周不存在第 4 位评委。
  - `0`：选手已淘汰后续周统一补 0（可用来推断“最后参赛周”）。
- **需要在 Q1 中显式处理的现实情况**：
  - 退赛（`Withdrew`）
  - 可能存在“无淘汰周/双淘汰周”（题面提示存在）

### 1.2 外生数据（你爬取的 raw）

- `us_census_2020_state_population.csv`
  - **可信度高**：来自 Census API，带元数据；字段简单。
  - **注意 join**：官方数据 `celebrity_homestate` 可能为空或为 `Washington D.C.` 等，需要映射到 `District of Columbia`；非美国选手不应强行合并。

- `dwts_wikipedia_pageviews.csv`
  - **方法可信**：Wikimedia Pageviews API，可复现（meta 记录了 API 模板与抓取时间）。
  - **覆盖限制**：meta 明确 pageviews 历史覆盖下限约为 `2015-07-01`，早期赛季天然缺失。
  - **当前文件规模很小**（目前仅看到 season 27 的若干选手行），说明现阶段抓取结果可能未覆盖全部可覆盖赛季；Q1 主线不应依赖其“全覆盖”。

- `dwts_google_trends.csv`
  - **只能当弱参考**：pytrends 非官方且不稳定；文件中存在大量 `TooManyRequestsError`，且整体只覆盖到 season 20 左右（受 `max_queries` 安全上限影响）。
  - 结论：Q1 主线建议默认不用 Trends；如用，仅作为“可用则用”的补充先验，并做严格质量控制（`trends_status==ok & n_points>0`）。

## 2. 统一符号与数据结构（Q1 的“真源表”设想）

将 wide 表转换为 weekly panel（概念层面，不在本阶段写代码）：

- 索引：`(s, t, i)` 分别表示 season、week、contestant。
- 观测：
  - 评委总分：`J_{s,t,i} = sum_k score_{s,t,i,k}`（忽略 N/A）
  - 是否仍在赛：`active_{s,t,i}`（该周是否有非零且非缺失的有效评分）
  - 当周淘汰集合：`E_{s,t}`（可能为空/可能包含多名）

## 3. 机制建模：Percent vs Rank

题面给了两种合并方式：

### 3.1 Percent 机制（常见于 S3–S27）

当周仍在赛的选手集合记为 `A_{s,t}`，人数 `n_{s,t}`。

- 评委份额（已知）：
  - `pJ_{s,t,i} = J_{s,t,i} / sum_{j in A_{s,t}} J_{s,t,j}`
- 粉丝份额（未知决策变量）：
  - `pF_{s,t,i} >= 0`，`sum_{i in A_{s,t}} pF_{s,t,i} = 1`
- 合并得分（份额相加）：
  - `T_{s,t,i} = pJ_{s,t,i} + pF_{s,t,i}`

**硬约束版（用于解释“可行域”）**

- 单淘汰：若观测淘汰者为 `e`，则
  - `T_{s,t,e} <= T_{s,t,j}` 对所有 `j in A_{s,t}`
- 双淘汰：淘汰集合 `E` 应是 `T` 的最小两个（需处理并列）。

**软约束版（更现实，推荐作为主线 likelihood）**

用温度参数 `tau>0` 将“最低者淘汰”放松为概率：

- 单淘汰：
  - `Pr(eliminate=i | pF) = softmax(-T_{s,t,i} / tau)`
- 双淘汰：
  - 可用 sequential sampling：先按 softmax 抽一个淘汰，再在剩余里抽第二个；或近似用“两个最小”的 Gumbel-top-k。
- 无淘汰周：
  - 令该周不进入似然（只做先验更新/平滑），或显式引入 `Pr(no elimination)` 的混合模型。

### 3.2 Rank 机制（S1–S2，以及 S28–S34 合理假设）

- 评委名次（已知）：
  - `rJ_{s,t,i}`：按 `J_{s,t,i}` 从高到低排名；平分可用平均名次/最小名次/随机打破（需在文中声明）。
- 粉丝名次（未知）：
  - `rF_{s,t,i}` 为 `1..n` 的排列（每周一个 permutation）。
- 合并名次：
  - `S_{s,t,i} = rJ_{s,t,i} + rF_{s,t,i}`
- 淘汰规则：`S` 最大者更可能被淘汰。

同样建议用 `tau` 做软约束：
- `Pr(eliminate=i | rF) = softmax(S_{s,t,i} / tau)`

## 4. 先验设计（把外生数据“正确地用在可解释位置”）

### 4.1 Percent 机制：Dirichlet 先验（简单可控）

- `pF_{s,t,*} ~ Dirichlet(alpha_{s,t,*})`
- 设 `alpha_{s,t,i} = 1 + c * pop_{s,t,i}`
  - `pop` 为归一化的人气 proxy（优先 wiki pageviews；其次 trends；再次可用州人口作弱 proxy；都没有则 `pop=0`）。
  - `c` 控制先验强度（越大越“相信人气”）。

### 4.2 Rank 机制：Plackett–Luce / Gumbel 排名先验（更“炫技”）

给每位选手一个 latent utility：`u_{s,t,i} = beta0 + beta_pop * pop_{s,t,i}`

- `rF` 服从 Plackett–Luce：排名越靠前概率越大。
- 好处：可以平滑地吸收外生人气，且天然输出排名不确定性。

## 5. 推断算法路线（不写代码，但保证可实现）

### 5.1 Percent：重要性采样 / SMC（推荐）

每个 `(s,t)` 独立或弱耦合（KISS）：

1. 从先验采样 `pF^(m) ~ Dirichlet(alpha)`
2. 计算 `T^(m)`
3. 计算权重 `w^(m) = Pr(observed elimination | T^(m), tau)`
4. 归一化权重并重采样（必要时）
5. 得到 `pF` 的后验样本 → 汇总均值/分位数/指数。

### 5.2 Rank：枚举不可行，走随机生成 + 加权

- 方案 A：从 Plackett–Luce 先验采样 `rF`，按 soft constraint 给权重。
- 方案 B（更硬核）：对 `rF` 做 MCMC（在 permutation space 上交换 proposal），目标分布为后验。

## 6. 不确定性量化（题目明确要求）

每个 `(s,t,i)` 输出至少以下 3 类：

- **区间宽度**：`IQR(pF_{i})` 或 `CI95(pF_{i})`；对指数则在 logit 空间做区间。
- **熵/信息量**：后验熵 `H(pF_{*})` 或单个选手边缘熵。
- **可辨识性 proxy**：重要性采样的 ESS、或硬约束拒绝采样的接受率。

直觉对应题目描述：
- “高评委分选手却被淘汰” → 必须解释为 `pF` 极低，后验可行域更窄 → 不确定性更小。

## 7. 一致性度量（题目 Q1 子问）

除了“我们强制拟合淘汰”，还要量化一致性：

- **周级一致性**：`Pr(observed elimination | data)`（后验平均）
- **季级一致性**：用后验样本模拟整季淘汰路径，计算真实冠军/前3 出现概率，或真实淘汰周命中率。

## 8. 计划交付（用于论文与后续实现的对齐）

- 表：
  - 每周每人 `fan_vote_share_mean/median/CI` + `certainty`
  - 每周“争议指数”：`rank_corr(rJ, rF)` 或 `|rJ-rF|` 的汇总
- 图：
  - `season-week` 维度的 uncertainty 热图（炫技且直观）
  - 争议选手（Bobby Bones 等）在关键周的后验分布对比

## 9. 风险与应对

- **外生数据覆盖不全**：默认用弱先验（`alpha=1`），在 season 27 等有 pageviews 时再做“有先验 vs 无先验”的敏感性对照。
- **无淘汰/双淘汰/退赛**：必须在 likelihood 设计中显式允许，否则会出现“无可行解”。
- **机制切换季不确定（S28 假设）**：做敏感性分析：把切换季当参数，在 `S27–S29` 附近对比结论稳定性。